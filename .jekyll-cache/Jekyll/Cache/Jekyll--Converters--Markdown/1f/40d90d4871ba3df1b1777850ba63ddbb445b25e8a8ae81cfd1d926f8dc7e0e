I"!6<h1 id="pairwise-identifier-auto-collection">Pairwise Identifier Auto-Collection</h1>

<p>One of the primary goals of the Sign In Canada Acceptance platform is to
facilitate the replacement of old credential service provider systems, in
particular, the outsourced legacy GCKey and Credential Broker Service systems
that have been in use since 2011.</p>

<p>One of the key prerequisites for decommissioning or replacing these old systems
is to move the pairwise identifier mappings currently held by these older
services to the Acceptance Platform, so that users’ enrolments with relying
parties are not impacted when relying parties move to the Sign In Canada
platform.</p>

<p>The Sign In Canada Acceptance Platform implements a feature that is able to
automatically copy a user’s pairwise identified mappings from a legacy
credential service to the Acceptance Platform the first time they are used.
These are then stored by the Acceptance Platform for future use, so that the
mapping stored by the credential service is no longer required. This reduces the
risk and effort required to move this data. Over time the mapping data of active
users is gradually “collected” by the Acceptance Platform, reducing the need to
regularly copy the data manually via some kind of “bulk transfer”.</p>

<h2 id="how-it-works">How it works</h2>

<p>The Acceptance Platform accomplishes the automatic collection of pairwise
identifier mappings as part of the normal user login process, by sending a second
SAML authentication request to the legacy credential service providers when
required.</p>

<ol>
  <li>The process begins when a relying party sends an authentication request to
the Acceptance Platform, using either OpenID Connect or SAML.</li>
  <li>The Acceptance Platform then sends an authentication request to the CSP on
its own behalf. Requesting the pairwise identifier that the CSP has created
for Sign In Canada.</li>
  <li>Upon receiving the SAML Assertion from the CSP, the Acceptance Platform looks
the user up in its own user profile repository.</li>
  <li>The Acceptance Platform then checks to see if it already has a pairwise
identifier mapping for the authenticated user with the requesting relying
party. If so, then collection is not required, the login flow completes
normally, and the Acceptance platform returns the appropriate pairwise
identifier to the relying party (RP).</li>
  <li>If however, the Acceptance Platform does not have a pairwise identifier
mapping for the authenticated user with the requesting relying party, then it
sends a second authentication request to the CSP on the relying party’s
behalf.</li>
  <li>If the CSP has an existing pairwise identifier for the user with the
requesting RP, it returns that identifier in an Assertion and the Acceptance
platform adds it to its own user repository. At this point, the identifier
has been “collected” by the Acceptance platform, and will be used whenever
the user logs into that RP in the future (as per step 4 above).</li>
  <li>If the CSP does not have an existing pairwise identifier for the user with
the requesting RP then there is nothing to “collect”, so the Acceptance
Platform creates a new identifier for the user with the requesting RP, and
that identifier is used for all future logins.</li>
</ol>

<h2 id="technical-details">Technical Details</h2>

<p>When sending a second authentication request to the CSP on behalf or the relying
party, the Acceptance Platform makes use of the <code class="language-plaintext highlighter-rouge">&lt;NameIDPolicy&gt;</code> element of the
SAML <code class="language-plaintext highlighter-rouge">&lt;AuthnRequest&gt;</code> message. Specifically, it uses the following two
attributes of the <code class="language-plaintext highlighter-rouge">&lt;NameIDPolicy&gt;</code> element:</p>

<ul>
  <li>The value of the <code class="language-plaintext highlighter-rouge">SPNameQualifier</code> attribute is populated with the old SAML
Entity Id of the requesting relying party, to indicate that the Acceptance
Platform is requesting the RP’s pairwise identifier instead of its own.</li>
  <li>The value of the <code class="language-plaintext highlighter-rouge">AllowCreate</code> attribute is set to <code class="language-plaintext highlighter-rouge">"false"</code>, to indicate to
the CSP that it should not create a new pairwise identifier for the RP if is
does not already have one.</li>
</ul>

<p>Here is an example of an authentication request issued by the Acceptance
Platform on behalf of itself:</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;samlp:AuthnRequest</span> <span class="na">xmlns:samlp=</span><span class="s">"urn:oasis:names:tc:SAML:2.0:protocol"</span> <span class="na">ID=</span><span class="s">"_f8e30829f6f60061c46e"</span>
                    <span class="na">Version=</span><span class="s">"2.0"</span> <span class="na">IssueInstant=</span><span class="s">"2021-05-05T17:17:02.583Z"</span>
                    <span class="na">ProtocolBinding=</span><span class="s">"urn:oasis:names:tc:SAML:2.0:bindings:HTTP-POST"</span>
                    <span class="na">Destination=</span><span class="s">"https://clegc-gckey.gc.ca/j/SSORedirect/metaAlias/GCKey/idp"</span>
                    <span class="na">AssertionConsumerServiceURL=</span><span class="s">"https://auth.id.canada.ca/passport/auth/saml/gckey/callback"</span><span class="nt">&gt;</span>
   <span class="nt">&lt;saml:Issuer</span> <span class="na">xmlns:saml=</span><span class="s">"urn:oasis:names:tc:SAML:2.0:assertion"</span><span class="nt">&gt;</span>
      https://auth.id.canada.ca
   <span class="nt">&lt;/saml:Issuer&gt;</span>
   <span class="nt">&lt;samlp:NameIDPolicy</span> <span class="na">xmlns:samlp=</span><span class="s">"urn:oasis:names:tc:SAML:2.0:protocol"</span>
                       <span class="na">Format=</span><span class="s">"urn:oasis:names:tc:SAML:2.0:nameid-format:persistent"</span>
                       <span class="na">AllowCreate=</span><span class="s">"true"</span>
                       <span class="na">SPNameQualifier=</span><span class="s">"https://auth.id.canada.ca"</span><span class="nt">/&gt;</span>
   <span class="nt">&lt;samlp:RequestedAuthnContext</span> <span class="na">xmlns:samlp=</span><span class="s">"urn:oasis:names:tc:SAML:2.0:protocol"</span> <span class="na">Comparison=</span><span class="s">"exact"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;saml:AuthnContextClassRef</span> <span class="na">xmlns:saml=</span><span class="s">"urn:oasis:names:tc:SAML:2.0:assertion"</span><span class="nt">&gt;</span>
         urn:gc-ca:cyber-auth:assurance:loa2
      <span class="nt">&lt;/saml:AuthnContextClassRef&gt;</span>
   <span class="nt">&lt;/samlp:RequestedAuthnContext&gt;</span>
<span class="nt">&lt;/samlp:AuthnRequest&gt;</span>
</code></pre></div></div>

<p>Here is an example of an authentication request issued by the Acceptance
Platform on behalf of a relying party:</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;samlp:AuthnRequest</span> <span class="na">xmlns:samlp=</span><span class="s">"urn:oasis:names:tc:SAML:2.0:protocol"</span> <span class="na">ID=</span><span class="s">"_f8e30829f6f60061c46f"</span>
                    <span class="na">Version=</span><span class="s">"2.0"</span> <span class="na">IssueInstant=</span><span class="s">"2021-05-05T17:20:02.583Z"</span>
                    <span class="na">ProtocolBinding=</span><span class="s">"urn:oasis:names:tc:SAML:2.0:bindings:HTTP-POST"</span>
                    <span class="na">Destination=</span><span class="s">"https://clegc-gckey.gc.ca/j/SSORedirect/metaAlias/GCKey/idp"</span>
                    <span class="na">AssertionConsumerServiceURL=</span><span class="s">"https://auth.id.canada.ca/passport/auth/saml/gckey/callback"</span><span class="nt">&gt;</span>
   <span class="nt">&lt;saml:Issuer</span> <span class="na">xmlns:saml=</span><span class="s">"urn:oasis:names:tc:SAML:2.0:assertion"</span><span class="nt">&gt;</span>
      https://auth.id.canada.ca
   <span class="nt">&lt;/saml:Issuer&gt;</span>
   <span class="nt">&lt;samlp:NameIDPolicy</span> <span class="na">xmlns:samlp=</span><span class="s">"urn:oasis:names:tc:SAML:2.0:protocol"</span>
                       <span class="na">Format=</span><span class="s">"urn:oasis:names:tc:SAML:2.0:nameid-format:persistent"</span>
                       <span class="na">AllowCreate=</span><span class="s">"false"</span>
                       <span class="na">SPNameQualifier=</span><span class="s">"https://relyingparty.department.gc.ca"</span><span class="nt">/&gt;</span>
   <span class="nt">&lt;samlp:RequestedAuthnContext</span> <span class="na">xmlns:samlp=</span><span class="s">"urn:oasis:names:tc:SAML:2.0:protocol"</span> <span class="na">Comparison=</span><span class="s">"exact"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;saml:AuthnContextClassRef</span> <span class="na">xmlns:saml=</span><span class="s">"urn:oasis:names:tc:SAML:2.0:assertion"</span><span class="nt">&gt;</span>
         urn:gc-ca:cyber-auth:assurance:loa2
      <span class="nt">&lt;/saml:AuthnContextClassRef&gt;</span>
   <span class="nt">&lt;/samlp:RequestedAuthnContext&gt;</span>
<span class="nt">&lt;/samlp:AuthnRequest&gt;</span>
</code></pre></div></div>

<h2 id="frequently-asked-questions">Frequently Asked Questions</h2>

<h3 id="what-does-the-user-experience-do-they-need-to-enter-their-password-twice">What does the user experience? Do they need to enter their password twice?</h3>

<p>This process takes advantage of the Single Sign On features inherent in SAML, so
that the user will not have to authenticate more than once, if at all:</p>

<ul>
  <li>If the user is not already logged in to the CSP, or if they are logged in
but the single sign-on (SSO) window (20 minutes with the GCCF CSPs) has
expired, they will be prompted to authenticate after the first SAML
authentication request. After they successfully log in to the CSP, the the
Acceptance Platform then sends the second authentication request a fraction of
a second later, well within the SSO window, so they will not be prompted to
login a second time.</li>
  <li>In the unlikely case where the user is already logged in to the CSP, but the
SSO window expires within the fraction of a second between the two
authentication requests, then SSO will apply to the first request, but not to
the second. Again, the user only needs to provide their credentials once.</li>
  <li>If the user is already logged in to the CSP, and both authentication requests
are processed within the SSO window, then the CSP will not prompt the user to
re-enter their credentials at all. The relying party can override this
behaviour by specifying <code class="language-plaintext highlighter-rouge">prompt="login"</code> (for OpenID Connect) or
<code class="language-plaintext highlighter-rouge">forceAuthn="true"</code> (in SAML) in their authentication request to Sign In
Canada, in which case the Acceptance Platform will specify
<code class="language-plaintext highlighter-rouge">forceAuthn="true"</code> on it’s first request to the CSP, but not the second.</li>
</ul>

<h3 id="what-if-the-user-at-the-keyboard-changes-is-there-a-risk-that-the-acceptance-platform-could-collect-the-wrong-identifier-belonging-to-the-wrong-person">What if the user at the keyboard changes? Is there a risk that the Acceptance Platform could collect the wrong identifier belonging to the wrong person?</h3>

<p>This possible scenario can arise in cases where multiple people are sharing the
same device, and one of them has left the device unattended while they were
still logged in to the CSP. For example:</p>

<p>Consider two users, Alice and Bob, who both have access to the same shared computer:</p>

<ul>
  <li>Alice logs into a GCCF relying party using her GCKey, but then walks away from
the computer without logging off.</li>
  <li>Bob then sits down at the same computer and attempts to log in to a Sign In
Canada relying party, just a few seconds before Alice’s 20 minute single-sign
on window expires.</li>
  <li>The Acceptance platform sends the first authentication request to GCKey, and
receives Alice’s pairwise identifier in return.</li>
  <li>Alice’s SSO window then expires in the fraction of a second before the
Acceptance Platform sends the second authentication request. GCKey prompts Bob
to enter his GCKey credentials and then returns Bob’s pairwise identifier to
the Acceptance Platform.</li>
  <li>The Acceptance platform then associates Bob’s GCKey identifier with Alice’s
user profile.</li>
</ul>

<p>In order to safeguard against this, the Acceptance Platform checks the
<code class="language-plaintext highlighter-rouge">SessionIndex</code> of both SAML Assertions, and makes sure that they match before
accepting the collected identifier.</p>

<h3 id="saml-pairwise-identifiers-issued-by-an-identity-provider-idp-are-supposed-to-be-specific-to-a-saml-service-provider-sp-how-is-sign-in-canada-allowed-to-obtain-the-identifiers-generated-for-another-saml-sp">SAML Pairwise identifiers issued by an identity provider (IDP) are supposed to be specific to a SAML service provider (SP). How is Sign In Canada allowed to obtain the identifiers generated for another SAML SP?</h3>

<p>The SAML specifications allow for the existence of <em>Affiliations</em>: groups of one or more SPs that share the same pairwise identifier for a given user. When a relying party moves from the GCCF to Sign In Canada, a new SAML Affiliation is defined, via SAML metadata, that allows the Acceptance Platform to obtain the pairwise identifiers that were originally created for the RP.</p>
:ET